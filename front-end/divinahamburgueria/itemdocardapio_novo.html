<html>

	<head>
		<meta charset="utf8"/>
		<script src="jquery/jquery3.6.js"></script>
		<link rel="stylesheet" href="bootstrap/dist/css/bootstrap.css" >
		<script src="bootstrap/dist/js/bootstrap.js"></script>
        <link rel="stylesheet" href="css/sistema.css" >
        <script src="js/sistema.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	</head>

	<body>        

		<div class="setecincoporcento">

			<input type="hidden" id="idusuario" value="0">

			<br/>
			<a href="home.html">Home</a>		
			<br/>

			<br/>
			<h1 class="floatleft">Novo item do cardápio</h1>
			<label class="floatright widthvintecincoporcento"><label class="asterisk"></label>
				Campos obrigatórios
			</label>
			<br/>
			<div class="clearboth"></div>
			<br/>

		</div>

		<div id="base_ITE" class="setecincoporcento">
		</div>

		<div id="base_REC" class="setecincoporcento">
		</div>

		<div id="base_REC_LIN" class="setecincoporcento displaynone">
		</div>

		<div id="base_REV" class="setecincoporcento">
		</div>

		<div id="base_ENV" class="setecincoporcento">
		</div>

	</body>

	<script>

		var _loadITECompleted = false;
		var _loadEnvCompleted = false;

		$(document).ready(function() {
			if (CheckLogin() == false)
				return;
			$("#base_ITE").load("itemdocardapio_base_ITE.html", function (){
				$("#adicionarReceita").prop("checked", false);
				$("#adicionarRevenda").prop("checked", false);
				_loadITECompleted = true;
				StartLoadLists();
			}); 
			$("#base_ENV").load("itemdocardapio_base_ENV.html", function (){
				_loadEnvCompleted = true;
				StartLoadLists();
			}); 
		});

		function CheckLogin(){
			var idusuario = getLoggedUserId();
			if (idusuario == -1)
			{
				var page =  window.location.pathname.split("/").pop();
				window.location.href = window.location.href.replace(page,'login.html');	
				return false;					
			}								
			else
			{
				$('#idusuario').val(idusuario);
				return true;
			}
		}

		function StartLoadLists(){
			if (!_loadITECompleted)
				return;
			if (!_loadEnvCompleted)
				return;
			LoadLists();
		}

		var _itemdoestoque_revenda_list;
		var _itemdoestoque_receita_list = [];

		function LoadLists(){
			WebApi_GET_LIST_ItemDoEstoque
			(
				'?tipo=2', 
				function success(data) {
					//console.log(data);	
					_itemdoestoque_revenda_list = data;																
				},
				function complete(xhr, text) {
					console.log(xhr.status);
					//console.log(xhr.responseText);					
				}     
			);
			WebApi_GET_LIST_ItemDoEstoque
			(
				'?tipo=1', 
				function success(data) {
					//console.log(data);	
					data = data.sort((a, b) => (a.nome > b.nome) ? 1 : -1);	
					var i, last;					
					for (i=0; i<data.length; i++){					
						if (data[i].nome != last)
							_itemdoestoque_receita_list.push(data[i]);
						last = data[i].nome;						
					}									
				},
				function complete(xhr, text) {
					console.log(xhr.status);
					//console.log(xhr.responseText);					
				}     
			);
		}

		function EnviarClick()
		{	
						
			if (ValidarItemDoCardapio() == false)
				return;

			var tipo;
			if ($("#adicionarReceita").val() == 1){
				tipo = 1;
			}
			if ($("#adicionarRevenda").val() == 1){
				tipo = 2;
			}

			if ($('#id').val() == 0){
				WebApi_POST_ItemDoCardapio
				(
					{nome : $('#nome').val() , descricao : $('#descricao').val(), fotografia : $('#fotografia').val(), tipo : tipo},
					function success(data){
						//console.log(data);
						$('#id').val(data.id);
						if (tipo == 1)
							CrudReceita(1);
						if (tipo == 2)
							CrudRevenda();
					},
					function complete(xhr, text){
						console.log(xhr.status);
						//console.log(xhr.responseText);
						if (xhr.status == 201){
							$('#falha').css('display','none');
							$('#sucesso').css('display','block');
							$('#sucesso').html("O item do cardápio foi criado com sucesso! <a href='itemdocardapio_listar.html'>Seguir para a lista de itens do cardápio</a>");			
						}
						else{
							$('#sucesso').css('display','none');
							$('#falha').css('display','block');
							$('#falha').text("Ocorreu uma falha: " + xhr.responseText);
						}
					}
				);
			}
			else{

				WebApi_PUT_ItemDoCardapio
				(
					$('#id').val(),
					{nome : $('#nome').val() , descricao : $('#descricao').val(), fotografia : $('#fotografia').val(), tipo : tipo },
					function success(data){
						//console.log(data);
					},
					function complete(xhr, text){
						console.log(xhr.status);
						//console.log(xhr.responseText);
						if (xhr.status == 200){
							$('#falha').css('display','none');
							$('#sucesso').css('display','block');
							$('#sucesso').html("O item do cardápio foi editado com sucesso! <a href='itemdocardapio_listar.html'>Seguir para a lista de itens do cardápio</a>");			
						}
						else{
							$('#sucesso').css('display','none');
							$('#falha').css('display','block');
							$('#falha').text("Ocorreu uma falha: " + xhr.responseText);
						}
					}
				);
				if (tipo == 1)
					CrudReceita(1);
				if (tipo == 2)
					CrudRevenda();				
			}		

		}

	</script>

</html>